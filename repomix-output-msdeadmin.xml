This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
index.js
knexfile.js
package.json
src/config/db.js
src/config/supabaseAdmin.js
src/controllers/adminController.js
src/routes/adminRoutes.js
src/services/emailService.js
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".gitignore">
.env
node_modules/
npm-debug.log*
yarn-debug.log*
yarn-error.log*
*.log
Thumbs.db
ehthumbs.db
Desktop.ini
.vscode/
</file>

<file path="src/config/db.js">
const knex = require('knex');
const knexFile = require('../../knexfile');
const db = knex(knexFile.development);

module.exports = db;
</file>

<file path="src/config/supabaseAdmin.js">
const { createClient } = require('@supabase/supabase-js');
require('dotenv').config();

const supabaseAdmin = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY,
  {
    auth: {
      autoRefreshToken: false,
      persistSession: false
    }
  }
);

module.exports = supabaseAdmin;
</file>

<file path="knexfile.js">
require("dotenv").config();

module.exports = {
  development: {
    client: "pg",
    connection: {
      host: process.env.DB_HOST,
      user: process.env.DB_USER,
      password: process.env.DB_PASS,
      database: process.env.DB_NAME,
      port: process.env.DB_PORT || 6543,
      ssl: { rejectUnauthorized: false },
    },
    pool: { min: 2, max: 10 },
  },
};
</file>

<file path="src/routes/adminRoutes.js">
const express = require('express');
const router = express.Router();
const controller = require('../controllers/adminController');

router.get('/stats', controller.getStats);
router.get('/users', controller.getUsers);

router.post('/send-reset-email', controller.sendResetLink);
router.post('/update-password', controller.updatePasswordAuth);

router.patch('/users/request-deletion/:id', controller.requestAccountDeletion);
router.delete('/users/:id', controller.deleteUser);

router.post('/verify-admin', controller.verifyAdmin); 
router.post('/create-specialist', controller.createSpecialist);

module.exports = router;
</file>

<file path="package.json">
{
  "name": "ms-admin-health",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "start": "node index.js",
    "dev": "nodemon index.js"
  },
  "repository": {
    "type": "git",
    "url": "git+https://github.com/Yeider15/ms-admin-health.git"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "bugs": {
    "url": "https://github.com/Yeider15/ms-admin-health/issues"
  },
  "homepage": "https://github.com/Yeider15/ms-admin-health#readme",
  "dependencies": {
    "@emailjs/nodejs": "^5.0.2",
    "@supabase/supabase-js": "^2.90.1",
    "cors": "^2.8.5",
    "dotenv": "^17.2.3",
    "express": "^5.2.1",
    "knex": "^3.1.0",
    "morgan": "^1.10.1",
    "pg": "^8.17.1"
  },
  "devDependencies": {
    "nodemon": "^3.1.11"
  }
}
</file>

<file path="index.js">
const express = require("express");
const cors = require("cors");
const morgan = require("morgan");
const adminRoutes = require("./src/routes/adminRoutes");
require("dotenv").config();

const app = express();
const PORT = process.env.PORT || 4000;

const requiredEnvVars = [
  "DB_HOST",
  "DB_USER",
  "DB_PASS",
  "DB_NAME",
  "EMAILJS_SERVICE_ID",
  "EMAILJS_TEMPLATE_ID",
  "EMAILJS_PUBLIC_KEY",
  "EMAILJS_PRIVATE_KEY",
  "FRONTEND_URL"
];

const missingEnvVars = requiredEnvVars.filter((envVar) => !process.env[envVar]);

if (missingEnvVars.length > 0) {
  console.error(`Error: Faltan variables de entorno: ${missingEnvVars.join(", ")}`);
  process.exit(1);
}

app.use(cors());
app.use(express.json());
app.use(morgan("dev"));

app.use("/api/admin", adminRoutes);

app.get("/", (req, res) => {
  res.send("MS Admin Health - Servicio Activo");
});

app.use((err, req, res, next) => {
  res.status(500).json({ error: "Error interno del servidor" });
});

app.listen(PORT, () => {
  console.log(`Servidor iniciado en puerto ${PORT}`);
});
</file>

<file path="src/controllers/adminController.js">
const db = require('../config/db');
const supabaseAdmin = require('../config/supabaseAdmin');
const { sendResetEmail } = require('../services/emailService');

const getStats = async (req, res) => {
  try {
    const total = await db('profiles').count('id as count').first();
    const active = await db('profiles')
      .where('last_seen', '>=', db.raw("NOW() - INTERVAL '30 days'"))
      .count('id as count')
      .first();

    const rolesRaw = await db('profiles')
      .select(db.raw('LOWER(role) as role'))
      .count('id as count')
      .groupByRaw('LOWER(role)');

    res.json({
      total: parseInt(total.count),
      active: active ? parseInt(active.count) : 0,
      roles: rolesRaw.map(r => ({
        role: r.role,
        count: parseInt(r.count)
      }))
    });
  } catch (error) {
    res.status(500).json({ error: 'Error al obtener estadísticas' });
  }
};

const getUsers = async (req, res) => {
  try {
    const users = await db('profiles')
      .select('id', 'rut', 'first_names', 'last_names', 'email', 'role', 'status', 'delete_requested_at')
      .orderBy('created_at', 'desc');

    const normalizedUsers = users.map(u => ({
      ...u,
      role: u.role ? u.role.toLowerCase() : 'user'
    }));

    res.json(normalizedUsers);
  } catch (error) {
    res.status(500).json({ error: 'Error al listar usuarios' });
  }
};

const sendResetLink = async (req, res) => {
  const { email } = req.body;
  try {
    const user = await db('profiles')
      .whereRaw('LOWER(email) = ?', [email.toLowerCase()])
      .first();

    if (!user) return res.status(404).json({ error: 'Usuario no encontrado' });

    const fullName = `${user.first_names} ${user.last_names}`;
    await sendResetEmail(user.email, fullName);
    
    res.json({ message: 'Correo enviado correctamente' });
  } catch (error) {
    res.status(500).json({ error: 'Error al enviar correo' });
  }
};

const updatePasswordAuth = async (req, res) => {
  const { email, newPassword } = req.body;
  try {
    const { data: { users }, error: listError } = await supabaseAdmin.auth.admin.listUsers();
    if (listError) throw listError;

    const userAuth = users.find(u => u.email.toLowerCase() === email.toLowerCase());
    if (!userAuth) return res.status(404).json({ error: 'Usuario no encontrado en Auth' });

    const { error: updateError } = await supabaseAdmin.auth.admin.updateUserById(
      userAuth.id,
      { password: newPassword }
    );
    if (updateError) throw updateError;

    res.json({ success: true, message: 'Contraseña actualizada' });
  } catch (error) {
    res.status(500).json({ error: 'Fallo al actualizar contraseña' });
  }
};

const deleteUser = async (req, res) => {
  const { id } = req.params;
  try {
    await db.transaction(async (trx) => {
      const user = await trx('profiles').where({ id }).first();
      if (!user) throw new Error('Usuario no existe');
      
      if (!user.delete_requested_at) {
        throw new Error('Solo se pueden eliminar usuarios con solicitud pendiente');
      }

      await trx('medical_records').where({ user_id: id }).del();
      await trx('sos_events').where({ user_id: id }).del();
      await trx('ia_chat_history').where({ user_id: id }).del();
      await trx('biometrics_history').where({ user_id: id }).del();
      await trx('profiles').where({ id }).del();
      await supabaseAdmin.auth.admin.deleteUser(id);
    });

    res.json({ message: 'Usuario y registros eliminados permanentemente' });
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
};

const verifyAdmin = async (req, res) => {
  const { email } = req.body;
  if (!email) return res.status(400).json({ isAdmin: false });

  try {
    const user = await db('profiles')
      .select('role')
      .whereRaw('LOWER(email) = ?', [email.toLowerCase()]) 
      .first();

    const isAdmin = user && user.role && user.role.toLowerCase() === 'admin';
    return res.json({ isAdmin: !!isAdmin });
  } catch (error) {
    res.status(500).json({ error: 'Error verificando rol' });
  }
};

const requestAccountDeletion = async (req, res) => {
  const { id } = req.params;
  try {
    const user = await db('profiles').where({ id }).first();
    if (!user) return res.status(404).json({ error: 'Usuario no encontrado' });

    await db('profiles')
      .where({ id })
      .update({
        status: 'delete_requested',
        delete_requested_at: db.fn.now()
      });

    res.json({ success: true, message: 'Solicitud recibida' });
  } catch (error) {
    res.status(500).json({ error: 'Error al procesar solicitud' });
  }
};

const createSpecialist = async (req, res) => {
  const { email, password, first_names, last_names, rut } = req.body;

  try {
    const { data: authData, error: authError } = await supabaseAdmin.auth.admin.createUser({
      email: email,
      password: password,
      email_confirm: true,
      user_metadata: { first_names, last_names, rut, role: 'specialist' }
    });

    if (authError) throw authError;

    const userId = authData.user.id;

    await db('profiles')
      .insert({
        id: userId,
        email,
        rut,
        first_names,
        last_names,
        role: 'specialist',
        status: 'active'
      })
      .onConflict('id')
      .merge();

    res.status(201).json({ message: 'Especialista creado exitosamente', id: userId });

  } catch (error) {
    console.error("Error creando especialista:", error);
    res.status(500).json({ error: error.message || 'Error al crear especialista' });
  }
};

module.exports = { 
  getStats, 
  getUsers, 
  sendResetLink, 
  updatePasswordAuth, 
  deleteUser,
  verifyAdmin,
  requestAccountDeletion,
  createSpecialist
};
</file>

<file path="src/services/emailService.js">
const emailjs = require('@emailjs/nodejs');
require('dotenv').config();

const sendResetEmail = async (toEmail, name) => {
  if (!process.env.EMAILJS_SERVICE_ID || !process.env.EMAILJS_TEMPLATE_ID || !process.env.EMAILJS_PRIVATE_KEY) {
    throw new Error("Faltan credenciales de EmailJS");
  }

  const resetLink = `${process.env.FRONTEND_URL}/reset-password?email=${toEmail}`;
  
  const templateParams = {
    to_email: toEmail,
    to_name: name,
    reset_link: resetLink
  };

  try {
    const response = await emailjs.send(
      process.env.EMAILJS_SERVICE_ID,
      process.env.EMAILJS_TEMPLATE_ID,
      templateParams,
      {
        publicKey: process.env.EMAILJS_PUBLIC_KEY,
        privateKey: process.env.EMAILJS_PRIVATE_KEY,
      }
    );

    return { success: true, status: response.status };
  } catch (error) {
    throw new Error(`Fallo al enviar email: ${error.text || error.message}`);
  }
};

module.exports = { sendResetEmail };
</file>

</files>
